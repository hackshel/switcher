# DCP 上传流程

### 简介

这是我现在写的上传业务的简单说明，还没画出来流程图,现在是文字版本，稍后会补全到公司gitlab上；

gitlab地址是:[ndc-movie-upload](https://gitlab.huayingjuhe.com/DevGroup/ndc-movie-upload)

对于现在的逻辑，请帮忙查看

**个人名词定义**

> DCP：制作方给我放在smb 上的一个影片包

> 镜像：用于制作影片硬盘使用的qemu 格式的文件，可挂载到操作系统上，并拷贝影片文件到其中

> 版本(version): 一个DCP中CPL 对应的版本,一个DCP中会含有多个CPL或者PKL

> 虚拟母盘：多个DCP合订成一定大小（1T以下）的文件信息体，是镜像的描述信息

> 母盘:用于大批量复制分发到影院的硬盘的母体

```json
DCP包存在多重情况，定义如下:

存在一个CPL文件，一个PKL文件 ，是标准格式，hx 是这种基本模式 
存在多个CPL文件，一个PKL文件，是share 模式
存在多个CPL模式，多个PKL文件，是combo 模式

```



### 数据库部分

现有数据库上传部分有3个表

1.ndc_ul_dcp_info 存储DCP 基本信息

2.ndc_ul_dcp_files 存储DCP中所有文件列表

3.ndc_ul_dcp_version 存储DCP中 按照CPL 区分开的版本



这里标注：ndc_ul_dcp_version 里面的文件列表是按照CPL 文件里面存储的影片文件、语音文件、字幕文件的列表进行对应id 存储，id 为 ndc_ul_dcp_files 的 文件id，所以，不会包含很多xml 文件，校验文件，包含ASSETMAP，PKL，CPL本身等文件，这些文件的存储，只是在dcp_files 表中统一罗列。个人觉得VERSION中的文件，是不能包含这些文件的。



在文件推送到制作镜像的上海设备上时，也应该按照ndc_ul_dcp_info 和ndc_ul_dcp_files 中的文件列表进行制作、校验，这是从DCP 制作的角度上来说的。

version 是从影片版本的角度上来说的，和DCP 的制作，是有区别的。

### 业务逻辑介绍



##### 1. web 服务部分

该部分服务以uwsgi web service 方式提供。

用于用户查看smb 上的dcp 列表，用户选择上传，分析ASSETMAP 文件，PKL文件，CPL文件，按照dcp 信息，dcp 文件列表，dcp 版本信息划分开。

**基本流程如下：**

​	 1).用户打开页面，调用dcp_list 接口，返回所有的DCP列表

​	 2).用户选择DCP， 上传DCP

​	 3).接口接收到用户选择的DCP列表，列举DCP中所有文件，并且，将找出ASSETMEP或者ASSETMAP.xml 文件。

​	 4).ASSETMAP(.xml)文件中存储DCP中文件以及文件对应的UUID；

​	  5).按照ASSETMEP文件和dcp中的文件列表，合并两个列表，确定出那些是不存在于ASSETMAP中的文件，对该文件进行标记；

​     6). 按照ASSETMAP文件列表中的文件，找到CPL文件和PKL文件；

​     7).解析CPL 文件，文件中将列出CPL文件列表，CPL文件中存储各版本中的文件，已经语音、视频、字幕对应关系

​	 8).解析PKL文件，获得每个ASSETMAP，CPL文件列表中的sha1 哈希值，和文件类型等信息；

​	 9).将PKL文件名与CPL文件进行绑定，确定传输的DCP 对应PKL文件，并且确认是那种包情况；

​	 10).将PKL中的文件sha1 哈希值于整个DCP中文件列表绑定，用来以后的校验文件

​	 11).存储信息到数据库				

​				存储 ASSETMEP 中DCP 信息到dcp_info 表中

​				存储 ASSET文件列表以及dcp 内部文件所有列表到 dcp_files

​				存储CPL信息到dcp_version 表



​	**<font color="red">为什么要分析ASSETMAP、CPL、PKL 文件</font>**

​	1.ASSETMAP文件中，是基本的DCP包中基础信息，但是，这里面不包含 ASSETMAP文件本身，不包    

​      含有VOLINDEX.xml,*md5 等文件，需要和目录list 的所有文件比较，增加这些文件，并计算这些文件的sha1

​      并且，DCP中的字幕文件，放在子目录中，也是在ASSETMET文件中标注目录等结构。

​    2.PKL是所有需要校验文件的sha1 哈希值存储位置，只有解析这些文件，才能具体进行比较文件校验是否正确

​    3.CPL文件，根据不同的CPL文件，区分出不同的版本，并且和PKL进行绑定，确定是那种类型的DCP结构

​	4.所有文件在PKL和CPL中对,都以UUID作为文件名进行存储，所有UUID，只存储在ASSETMAP文件中；

​	5.只有分析ASSETMAP文件，才能避免在DCP中被增加的文件传输到公司之外，比如key;

​	6.CPL文件中只存储对应版本的语音、图像、字幕文件列表，并不存储其他部分

​	详细的接口，请查看服务接口建文档



##### 2.校验所有文件

​	这部分的服务，以uwsgi ework 的deamon 方式运行

​	deamon 程序定期（5s）查询数据库，当用户提交的DCP信息写入数据库之后，程序会查询一个DCP进行校验，校验过程如下：

​	1）找出DCP 文件信息，并按照DCP id 找到对应的所有文件列表，存储于dcp_files 中的完整文件列表;

​	2) 按照文件列表，校验文件。对文件进行sha1 校验,并计算base64；

​	3）如果不是存储在PKL中有sha1校验值的文件，直接校验文件的sha1 和base64 存储；

​	4）比较PKL中已经存储到数据库中的文件，并且检查两个数值是否一致；

​	5）所有文件检查文件结束，将DCP status 标记为完成，并将文件的状态标志为2

​	6）所有文件状态如下：

```json
dcp_status : 0: '还没开始处理'，
							1: '正在校验文件正确性'，
							2: '文件SHA1校验完成'，
							3: '文件开始上传'，
							4: '文件上传完中'，
							5: '正常，上传完成'，
							6: '暂停上传',
							7: '弃用/下架/停止下载',
							8: '云端删除',
							9: 'dcp 不存目录内,已经被删除',
							-1: '文件出现了故障',
							-2: 'DCP 不存在',
```





##### 3.上传文件

这部分的服务，以uwsgi ework 的deamon 方式运行

1)程序找出数据库中顺序递增的一个可以上传的DCP包；

2）找到一个该DCP中校验完成的文件；

3）查询该文件在RCT 中的状态，如果状态为5，就将该文件增加到RCT 的上传列表内开始上传，标记文件为上传中，标记DCP 状态为上传中

4）检查文件上传状态，如果传输出现故障，重传，抛出错误日志或者异常，写入数据库，并提交信息给管理员

5）检查上传状态，如果传输文件完成，就将文件状态标记为已经传完成

6）检查dcp中所有文件，如果文件全部上传完成，就直接将DCP 标记为全部传输完成



